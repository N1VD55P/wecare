<!-- views/prescriptions.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prescriptions - WeCare</title>
  <link rel="stylesheet" href="/css/prescriptions.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
</head>
<body>

  <%- include('partials/header', { page: 'prescriptions', showLogin: false }) %>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Rate Nurses Section -->
    <section class="rate-nurses-section">
      <h2 class="section-title">Rate Your Healthcare Providers</h2>
      <p class="section-subtitle">Help us improve by rating your experience with our nurses</p>

      <div class="appointments-history">
        <% 
        const sampleData = [
          {
            id: '1',
            nurseName: 'Nurse Vibha',
            serviceType: 'Home Visit - General Checkup',
            appointmentDate: '2025-11-15',
            status: 'completed',
            rating: null,
            feedback: '',
            image: 'https://img.freepik.com/premium-psd/png-smiling-indian-woman-nurse-pose-against-transparent-background-ideal-healthcare-medical-related-content_1031432-57667.jpg?w=360'
          },
          {
            id: '2',
            nurseName: 'Nurse Akansha Sharma',
            serviceType: 'Medication Review',
            appointmentDate: '2025-11-10',
            status: 'completed',
            rating: 4.5,
            feedback: 'Excellent service and very professional!',
            image: 'https://img.freepik.com/premium-psd/png-smiling-indian-woman-nurse-pose-against-transparent-background-ideal-healthcare-medical-related-content_1031432-58079.jpg?w=360'
          },
          {
            id: '3',
            nurseName: 'Nurse Priya Patel',
            serviceType: 'Wound Care & Dressing',
            appointmentDate: '2025-11-05',
            status: 'completed',
            rating: 5,
            feedback: 'Very caring and gentle. Made me feel comfortable during the entire visit.',
            image: 'https://img.freepik.com/premium-psd/png-smiling-indian-woman-nurse-pose-against-transparent-background-ideal-healthcare-medical-related-content_1031432-57200.jpg?w=360'
          }
        ];
        
        // Use sample data if no appointments exist, otherwise use real appointments
        const appointmentHistory = (typeof appointments !== 'undefined' && appointments.length > 0) ? appointments : sampleData;
        %>

        <% if (appointmentHistory.length === 0) { %>
          <div class="no-appointments">
            <p>No completed appointments to rate yet.</p>
          </div>
        <% } else { %>
          <% appointmentHistory.forEach(appointment => { %>
            <% if (appointment.status === 'completed') { %>
              <div class="rate-card">
                <div class="rate-card-header">
                  <div class="nurse-info">
                    <img src="<%= appointment.image %>" alt="<%= appointment.nurseName %>" class="nurse-avatar" />
                    <div class="nurse-details">
                      <h3><%= appointment.nurseName %></h3>
                      <p class="service-type"><%= appointment.serviceType %></p>
                      <p class="appointment-date">
                        <i class="fas fa-calendar"></i> 
                        <%= new Date(appointment.appointmentDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) %>
                      </p>
                    </div>
                  </div>
                </div>

                <div class="rate-card-body">
                  <% if (appointment.rating) { %>
                    <div class="rating-display">
                      <div class="stars">
                        <% for (let i = 0; i < 5; i++) { %>
                          <span class="star <%= i < appointment.rating ? 'filled' : 'empty' %>">⭐</span>
                        <% } %>
                      </div>
                      <p class="rating-text"><%= appointment.rating %> out of 5 stars</p>
                      <% if (appointment.feedback) { %>
                        <p class="feedback-text"><strong>Your feedback:</strong> "<%= appointment.feedback %>"</p>
                      <% } %>
                    </div>
                  <% } else { %>
                    <p class="no-rating-text">You haven't rated this appointment yet</p>
                  <% } %>
                </div>

                <div class="rate-card-footer">
                  <% if (!appointment.rating) { %>
                    <button class="rate-btn" onclick="openRatingModal('<%= appointment.id || appointment._id %>', '<%= appointment.nurseName %>')">
                      <i class="fas fa-star"></i> Rate Nurse
                    </button>
                  <% } else { %>
                    <button class="edit-rating-btn" onclick="openRatingModal('<%= appointment.id || appointment._id %>', '<%= appointment.nurseName %>')">
                      <i class="fas fa-edit"></i> Edit Rating
                    </button>
                  <% } %>
                </div>
              </div>
            <% } %>
          <% }); %>
        <% } %>
      </div>
    </section>

    <!-- Rating Modal (Same as patient portal) -->
    <div id="rating-modal" class="rating-modal-overlay" style="display: none;">
      <div class="rating-modal-content">
        <div class="rating-modal-header">
          <h2>Rate <span id="nurse-name-display"></span></h2>
          <button class="rating-modal-close" onclick="closeRatingModal()">&times;</button>
        </div>
        <form id="rating-form" onsubmit="submitRating(event)">
          <input type="hidden" id="appointment-id-input" />
          
          <div class="rating-input-group">
            <label>Your Rating:</label>
            <div class="star-rating" id="star-rating">
              <span class="star" data-rating="1">⭐</span>
              <span class="star" data-rating="2">⭐</span>
              <span class="star" data-rating="3">⭐</span>
              <span class="star" data-rating="4">⭐</span>
              <span class="star" data-rating="5">⭐</span>
            </div>
            <input type="hidden" id="rating-input" name="rating" required />
            <span id="rating-value-display"></span>
          </div>

          <div class="feedback-input-group">
            <label for="feedback">Feedback (Optional):</label>
            <textarea id="feedback" name="feedback" placeholder="Share your experience with this nurse..." rows="4"></textarea>
          </div>

          <div class="rating-modal-actions">
            <button type="button" class="rating-cancel-btn" onclick="closeRatingModal()">Cancel</button>
            <button type="submit" class="rating-submit-btn">Submit Rating</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="/js/prescriptions.js"></script>
  <script>
// Rating System Functions for Prescriptions Page
let selectedRating = 0;

function openRatingModal(appointmentId, nurseName) {
  document.getElementById('appointment-id-input').value = appointmentId;
  document.getElementById('nurse-name-display').textContent = nurseName;
  document.getElementById('rating-modal').style.display = 'flex';
  selectedRating = 0;
  updateStarDisplay();
  document.getElementById('feedback').value = '';
}

function closeRatingModal() {
  document.getElementById('rating-modal').style.display = 'none';
  selectedRating = 0;
  document.getElementById('rating-input').value = '';
  updateStarDisplay();
}

function setupStarRating() {
  const stars = document.querySelectorAll('.star');
  stars.forEach(star => {
    star.addEventListener('click', function() {
      selectedRating = parseInt(this.getAttribute('data-rating'));
      document.getElementById('rating-input').value = selectedRating;
      updateStarDisplay();
    });

    star.addEventListener('mouseover', function() {
      const hoverRating = parseInt(this.getAttribute('data-rating'));
      stars.forEach((s, index) => {
        if (index < hoverRating) {
          s.style.opacity = '1';
          s.style.color = '#FFD700';
        } else {
          s.style.opacity = '0.3';
        }
      });
    });
  });

  document.getElementById('star-rating').addEventListener('mouseout', updateStarDisplay);
}

function updateStarDisplay() {
  const stars = document.querySelectorAll('.star');
  const display = document.getElementById('rating-value-display');
  
  stars.forEach((star, index) => {
    if (index < selectedRating) {
      star.style.opacity = '1';
      star.style.color = '#FFD700';
    } else {
      star.style.opacity = '0.3';
      star.style.color = '#333';
    }
  });

  if (selectedRating > 0) {
    display.textContent = selectedRating + ' out of 5 stars';
    display.style.color = '#FFD700';
    display.style.marginTop = '10px';
  } else {
    display.textContent = '';
  }
}

function submitRating(event) {
  event.preventDefault();

  const appointmentId = document.getElementById('appointment-id-input').value;
  const rating = document.getElementById('rating-input').value;
  const feedback = document.getElementById('feedback').value;

  if (!rating) {
    alert('Please select a rating before submitting');
    return;
  }

  // Send rating to server
  fetch(`/patient/rate-nurse/${appointmentId}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      rating: parseInt(rating),
      feedback: feedback
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.ok) {
      alert('Thank you for rating! Your feedback helps other patients.');
      closeRatingModal();
      // Refresh page to show updated rating
      setTimeout(() => {
        location.reload();
      }, 500);
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to submit rating. Please try again.');
  });
}

// Initialize star rating when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  setupStarRating();

  // Close modal when clicking outside of it
  const ratingModal = document.getElementById('rating-modal');
  if (ratingModal) {
    ratingModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeRatingModal();
      }
    });
  }
});
  </script>
</body>
</html>